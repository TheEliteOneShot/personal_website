FROM bitnami/node:16 AS build
WORKDIR /app

ARG SITEMAP_HOST
ARG VITE_API_BASE_URL
ARG VITE_MAPBOX_ACCESS_TOKEN
ARG BACKEND_PORT
ARG BACKEND_HOST
ARG BACKEND_PROTOCOL
ARG BACKEND_PREFIX

COPY package.json ./
COPY yarn.lock ./
RUN CYPRESS_INSTALL_BINARY=0 yarn --frozen-lockfile

COPY . .
RUN SITEMAP_HOST=$SITEMAP_HOST \
  VITE_API_BASE_URL=$VITE_API_BASE_URL \
  VITE_MAPBOX_ACCESS_TOKEN=$VITE_MAPBOX_ACCESS_TOKEN \
  VITE_API_BASE_HOST=$BACKEND_HOST \
  VITE_API_BASE_PORT=$BACKEND_PORT \
  VITE_API_BASE_PREFIX=$BACKEND_PREFIX \
  VITE_API_BASE_PROTOCOL=$BACKEND_PROTOCOL \
  SILENT=1 \
  yarn run build

FROM bitnami/node:16-prod AS prod
WORKDIR /app

COPY --from=build /app .

CMD ["yarn", "preview"]